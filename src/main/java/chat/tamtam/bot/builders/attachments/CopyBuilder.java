package chat.tamtam.bot.builders.attachments;

import chat.tamtam.botapi.model.Attachment;
import chat.tamtam.botapi.model.AttachmentRequest;
import chat.tamtam.botapi.model.AudioAttachment;
import chat.tamtam.botapi.model.AudioAttachmentRequest;
import chat.tamtam.botapi.model.ContactAttachment;
import chat.tamtam.botapi.model.ContactAttachmentRequest;
import chat.tamtam.botapi.model.ContactAttachmentRequestPayload;
import chat.tamtam.botapi.model.FileAttachment;
import chat.tamtam.botapi.model.FileAttachmentRequest;
import chat.tamtam.botapi.model.InlineKeyboardAttachment;
import chat.tamtam.botapi.model.LocationAttachment;
import chat.tamtam.botapi.model.LocationAttachmentRequest;
import chat.tamtam.botapi.model.PhotoAttachment;
import chat.tamtam.botapi.model.PhotoAttachmentRequest;
import chat.tamtam.botapi.model.PhotoAttachmentRequestPayload;
import chat.tamtam.botapi.model.ShareAttachment;
import chat.tamtam.botapi.model.ShareAttachmentPayload;
import chat.tamtam.botapi.model.ShareAttachmentRequest;
import chat.tamtam.botapi.model.StickerAttachment;
import chat.tamtam.botapi.model.StickerAttachmentRequest;
import chat.tamtam.botapi.model.StickerAttachmentRequestPayload;
import chat.tamtam.botapi.model.UploadedInfo;
import chat.tamtam.botapi.model.User;
import chat.tamtam.botapi.model.VideoAttachment;
import chat.tamtam.botapi.model.VideoAttachmentRequest;

import java.util.stream.Stream;

/**
 * Creates {@link AttachmentRequest} from existing {@link Attachment}
 *
 * @author alexandrchuprin
 */
public class CopyBuilder implements AttachmentsBuilder, Attachment.Mapper<AttachmentRequest> {
    private final Attachment attachment;

    public CopyBuilder(Attachment attachment) {
        this.attachment = attachment;
    }

    @Override
    public AttachmentRequest map(PhotoAttachment model) {
        String token = model.getPayload().getToken();
        return new PhotoAttachmentRequest(new PhotoAttachmentRequestPayload().token(token));
    }

    @Override
    public AttachmentRequest map(VideoAttachment model) {
        return new VideoAttachmentRequest(new UploadedInfo().token(model.getPayload().getToken()));
    }

    @Override
    public AttachmentRequest map(AudioAttachment model) {
        return new AudioAttachmentRequest(new UploadedInfo().token(model.getPayload().getToken()));
    }

    @Override
    public AttachmentRequest map(FileAttachment model) {
        return new FileAttachmentRequest(new UploadedInfo().token(model.getPayload().getToken()));
    }

    @Override
    public AttachmentRequest map(StickerAttachment model) {
        return new StickerAttachmentRequest(new StickerAttachmentRequestPayload(model.getPayload().getCode()));
    }

    @Override
    public AttachmentRequest map(ContactAttachment model) {
        User tamInfo = model.getPayload().getTamInfo();

        ContactAttachmentRequestPayload payload;
        if (tamInfo != null) {
            payload = new ContactAttachmentRequestPayload(tamInfo.getName());
            payload.setContactId(tamInfo.getUserId());
        } else {
            payload = new ContactAttachmentRequestPayload(null);
        }
        payload.setVcfInfo(model.getPayload().getVcfInfo());

        return new ContactAttachmentRequest(payload);
    }

    @Override
    public AttachmentRequest map(InlineKeyboardAttachment model) {
        return InlineKeyboardBuilder.layout(model.getPayload().getButtons()).build();
    }

    @Override
    public AttachmentRequest map(ShareAttachment model) {
        return new ShareAttachmentRequest(new ShareAttachmentPayload()
                .token(model.getPayload().getToken())
                .url(model.getPayload().getUrl()));
    }

    @Override
    public AttachmentRequest map(LocationAttachment model) {
        return new LocationAttachmentRequest(model.getLatitude(), model.getLongitude());
    }

    @Override
    public AttachmentRequest mapDefault(Attachment model) {
        return null;
    }

    @Override
    public Stream<AttachmentRequest> build() {
        AttachmentRequest request = attachment.map(this);
        return request == null ? Stream.empty() : Stream.of(request);
    }
}
